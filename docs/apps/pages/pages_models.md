# pages_models Package Reference

**Note**: This documentation page was (in part) generated by ChatGPT and has been fully reviewed by [Nigel2392](github.com/Nigel2392).

The **pages_models** package is a dedicated subpackage of the Pages app. It encapsulates the core data model for page nodes and provides helper functions for managing page attributes and tree structure.

## Overview

At its core, the **pages_models** package defines the `PageNode` type, which represents a single page in the hierarchical tree. It also includes support for status flags, URL path generation, and standard field definitions.

## Key Types and Constants

### StatusFlag

`StatusFlag` is an enumerated type that represents various states of a page node.

```go
type StatusFlag int64

const (
    // Page is published.
    StatusFlagPublished StatusFlag = 1 << iota

    // Page is hidden.
    StatusFlagHidden

    // Page is marked as deleted.
    StatusFlagDeleted

    // No status flag. Useful for queries that ignore status.
    StatusFlagNone StatusFlag = 0
)
```

- **Is(flag StatusFlag) bool**  
  Returns `true` if the given flag is set.

### PageNode

`pages_models.PageNode` is the core model for page nodes.

```go
type PageNode struct {
    PK               int64      `json:"id" attrs:"primary;readonly"`
    Title            string     `json:"title"`
    Path             string     `json:"path"`
    Depth            int64      `json:"depth" attrs:"blank"`
    Numchild         int64      `json:"numchild" attrs:"blank"`
    UrlPath          string     `json:"url_path" attrs:"readonly;blank"`
    Slug             string     `json:"slug"`
    StatusFlags      StatusFlag `json:"status_flags" attrs:"null;blank"`
    PageID           int64      `json:"page_id" attrs:""`
    ContentType      string     `json:"content_type" attrs:""`
    LatestRevisionID int64      `json:"latest_revision_id" attrs:""`
    CreatedAt        time.Time  `json:"created_at" attrs:"readonly;label=Created At"`
    UpdatedAt        time.Time  `json:"updated_at" attrs:"readonly;label=Updated At"`

    // Parent and child relationships.
    ParentNode *PageNode   `json:"parent_node" attrs:"readonly"`
    ChildNodes []*PageNode `json:"child_nodes" attrs:"readonly"`
}
```

#### Methods

- **SetUrlPath(parent *PageNode) (newPath, oldPath string)**  
  Generates a new URL path for the node based on its slug and the parent node’s URL path. If the slug is empty, it is generated from the title.

- **ID() int64**  
  Returns the primary key (`PK`) of the node.

- **Reference() *PageNode**  
  Returns a reference to the node itself.

- **IsRoot() bool**  
  Returns `true` if the node is a root node (i.e., its depth is zero).

- **FieldDefs() attrs.Definitions**  
  Automatically generates field definitions for the node, using the attributes package.

## Database Transaction Interfaces

To abstract database operations, the **pages_models** package defines several interfaces:

- **DBTX**  
  Provides methods for executing queries and preparing statements with a context.

- **Querier**  
  Contains methods for querying and manipulating page nodes, including functions to retrieve nodes by various criteria, update node properties, and handle bulk operations.

- **DBQuerier**  
  Extends `Querier` by providing access to the underlying database connection and transaction management.

We also have custom database operations [outside of the `pages_models` package](./queries.md), these operations are generally useful for managing the tree structure and content of pages.

### The querier Interface

The **Querier** interface defines a set of methods for interacting with page nodes stored in your database. These methods allow you to:

- **Retrieve nodes:** Fetch nodes by ID, path, slug, depth, or content type.
- **Count nodes:** Determine the number of nodes under various filtering criteria.
- **Modify nodes:** Insert new nodes, update existing nodes, or delete nodes.
- **Manage relationships:** Increment or decrement the child count and update descendant paths.
- **Transaction handling:** Create a new querier instance bound to a specific transaction with `WithTx`.

For use cases where direct access to the underlying database connection or explicit transaction management is needed, the **DBQuerier** interface extends Querier with methods such as `DB()` and `BeginTx`.

---

## Method Reference

Below is a detailed description of each method defined on the **Querier** interface:

### General Methods

- **Close() error**  
  Closes the querier and releases any underlying resources.

- **WithTx(tx *sql.Tx) Querier**  
  Returns a new querier instance that operates within the provided transaction. Use this method to group multiple operations into a single transaction.

---

### Node Retrieval Methods

- **AllNodes(ctx context.Context, statusFlags StatusFlag, offset int32, limit int32) ([]PageNode, error)**  
  Retrieves all page nodes filtered by the given status flags, with support for pagination.

- **GetNodeByID(ctx context.Context, id int64) (PageNode, error)**  
  Retrieves a page node by its unique identifier.

- **GetNodeByPath(ctx context.Context, path string) (PageNode, error)**  
  Retrieves a page node based on its full URL path.

- **GetNodeBySlug(ctx context.Context, slug string, depth int64, path string) (PageNode, error)**  
  Retrieves a page node by its slug within the context of a specified depth and parent path.

- **GetChildNodes(ctx context.Context, path string, depth int64, statusFlags StatusFlag, offset int32, limit int32) ([]PageNode, error)**  
  Fetches the direct child nodes of a node identified by its path and depth, with filtering and pagination.

- **GetDescendants(ctx context.Context, path string, depth int64, statusFlags StatusFlag, offset int32, limit int32) ([]PageNode, error)**  
  Retrieves all descendant nodes under a given node, starting from a specific depth and applying filters.

- **GetNodesByDepth(ctx context.Context, depth int64, statusFlags StatusFlag, offset int32, limit int32) ([]PageNode, error)**  
  Returns nodes that reside at a particular depth in the tree.

- **GetNodesByIDs(ctx context.Context, id []int64) ([]PageNode, error)**  
  Retrieves multiple page nodes based on an array of node IDs.

- **GetNodesByPageIDs(ctx context.Context, pageID []int64) ([]PageNode, error)**  
  Retrieves page nodes associated with specific page IDs.

- **GetNodesByTypeHash(ctx context.Context, contentType string, offset int32, limit int32) ([]PageNode, error)**  
  Fetches nodes for a given content type (represented as a hash), with pagination support.

- **GetNodesByTypeHashes(ctx context.Context, contentType []string, offset int32, limit int32) ([]PageNode, error)**  
  Retrieves nodes matching any of the provided content type hashes.

- **GetNodesForPaths(ctx context.Context, path []string) ([]PageNode, error)**  
  Retrieves nodes that correspond to a list of URL paths.

---

### Node Count Methods

- **CountNodes(ctx context.Context, statusFlags StatusFlag) (int64, error)**  
  Returns the total number of nodes that match the specified status flags.

- **CountNodesByTypeHash(ctx context.Context, contentType string) (int64, error)**  
  Counts the nodes associated with a particular content type.

- **CountRootNodes(ctx context.Context, statusFlags StatusFlag) (int64, error)**  
  Counts the number of root nodes (nodes with a depth of zero) filtered by the given status flags.

---

### Node Modification Methods

- **InsertNode(ctx context.Context, title string, path string, depth int64, numchild int64, urlPath string, slug string, statusFlags int64, pageID int64, contentType string, latestRevisionID int64) (int64, error)**  
  Inserts a new page node into the database with the provided attributes. Returns the newly generated node ID.

- **UpdateNode(ctx context.Context, title string, path string, depth int64, numchild int64, urlPath string, slug string, statusFlags int64, pageID int64, contentType string, latestRevisionID int64, iD int64) error**  
  Updates the specified page node with new values.

- **UpdateNodes(ctx context.Context, nodes []*PageNode) error**  
  Performs a bulk update on a list of page nodes.

- **UpdateNodePathAndDepth(ctx context.Context, path string, depth int64, iD int64) error**  
  Updates the URL path and depth for a specific node, typically used when a node’s slug changes.

- **UpdateNodeStatusFlags(ctx context.Context, statusFlags int64, iD int64) error**  
  Modifies the status flags (e.g., published, hidden) for a node.

- **UpdateDescendantPaths(ctx context.Context, oldUrlPath, newUrlPath, pageNodePath string, id int64) error**  
  Updates the URL paths of all descendant nodes when a parent node’s URL path changes.

---

### Node Deletion and Child Count Methods

- **DeleteNode(ctx context.Context, id int64) error**  
  Deletes a single page node by its ID.

- **DeleteNodes(ctx context.Context, id []int64) error**  
  Deletes multiple nodes based on an array of IDs.

- **DeleteDescendants(ctx context.Context, path string, depth int64) error**  
  Deletes all descendant nodes of a given node based on its path and depth.

- **IncrementNumChild(ctx context.Context, id int64) (PageNode, error)**  
  Increments the `numchild` counter for the node with the specified ID and returns the updated node.

- **DecrementNumChild(ctx context.Context, id int64) (PageNode, error)**  
  Decrements the `numchild` counter for the node with the given ID and returns the updated node.

---

## DBQuerier Extension

For scenarios where direct access to the underlying SQL database is required, the **DBQuerier** interface extends **Querier** with additional methods:

- **DB() *sql.DB**  
  Returns the underlying database connection.

- **BeginTx(ctx context.Context, opts *sql.TxOptions) (*sql.Tx, error)**  
  Initiates a new transaction with the specified options, enabling multiple operations to be executed atomically.
