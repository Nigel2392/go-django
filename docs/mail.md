# Package `mail`

**Note**: This documentation page was (in part) generated by ChatGPT and has been fully reviewed by [Nigel2392](github.com/Nigel2392).

The `mail` package provides a flexible and configurable email sending system with support for multiple backends, including console-based and pooled email sending. It is designed for easy integration with SMTP servers, including options for TLS/SSL and connection pooling.

## Features

- **Configurable SMTP Settings**: Allows you to configure email server settings, including TLS, SSL, authentication, and timeout.
- **Backend Registry**: Supports multiple email backends, including console output for testing and SMTP for production.
- **Connection Pooling**: Enables efficient email sending using connection pooling for high-volume environments.
- **Flexible Interfaces**: Allows for adding custom backends and supports `OpenableEmailBackend` for backends that require resource management (e.g., connection pools).

## Components

### Types

#### `Config`

The `Config` struct holds the SMTP server configuration and credentials required for email authentication.

```go
type Config struct {
 Host        string        // Mail server host (e.g., smtp.gmail.com).
 Port        int           // Mail server port (e.g., 587 for TLS or 465 for SSL).
 Username    string        // Mail server username (your email address).
 Password    string        // Mail server password (your email password).
 UseTLS      bool          // Use TLS encryption for SMTP.
 UseSSL      bool          // Use SSL encryption for SMTP.
 MailFrom    string        // Default "From" address for sending emails.
 Timeout     time.Duration // Timeout duration for sending emails.
 TLSConfig   *tls.Config   // TLS configuration options.
 DefaultAuth smtp.Auth     // Default authentication method for the SMTP server.
}
```

**Functions in `Config`:**

- `Start(server *smtp.ServerInfo)`: Starts the SMTP authentication process.
- `Next(fromServer []byte, more bool)`: Continues the authentication process, responding with credentials based on server prompts.

### Backends

#### `EmailBackend`

The `EmailBackend` interface defines a contract for sending emails. Any backend (e.g., console, SMTP) must implement this interface.

```go
type EmailBackend interface {
 Send(e *email.Email) error
}
```

#### `OpenableEmailBackend`

An optional interface for backends that need to be explicitly opened and closed, such as connection pools.

```go
type OpenableEmailBackend interface {
 Open() error
 IsOpen() bool
 Close() error
}
```

### `pooledManager`

The `pooledManager` struct implements `OpenableEmailBackend` for sending emails using an SMTP connection pool.

```go
type pooledManager struct {
 cnf  *Config
 pool *email.Pool
}
```

**Functions in `pooledManager`:**

- `NewPooledEmailBackend(poolCount int, cnf *Config)`: Creates a new email backend with connection pooling.
- `Open()`: Initializes the backend (in this case, a no-op).
- `Send(e *email.Email)`: Sends an email using the connection pool.
- `Close()`: Closes the connection pool when done.

### `consoleManager`

The `consoleManager` is a backend that outputs emails to the console (useful for development and testing).

```go
type consoleManager struct {
 o io.Writer
}
```

**Functions in `consoleManager`:**

- `Send(e *email.Email)`: Converts the email to bytes and writes the output to the console or provided writer.

### Registry and Helper Functions

The package includes a backend registry that allows for dynamic backend registration and management.

- `Register(name string, backend EmailBackend)`: Registers a backend with the given name.
- `Unregister(name string)`: Removes a backend from the registry.
- `Get(name string) EmailBackend`: Retrieves a registered backend by name.
- `Default() EmailBackend`: Retrieves the default backend (usually the console backend).
- `SetDefault(backend EmailBackend)`: Sets a backend as the default backend.
- `Send(e *email.Email, backendOrName ...interface{})`: Sends an email using the specified backend or default backend.
- `Close[T string | interface{}](backendOrName T)`: Closes an `OpenableEmailBackend`.

### Error Handling

The package defines some common errors:

- `ErrConfigNil`: Raised when the configuration is `nil`.
- `ErrBackendNotFound`: Raised when a backend is not found in the registry.

## Example Usage

### Sending an Email via the Console Backend (Default)

```go
package main

import (
 "github.com/jordan-wright/email"
 "github.com/Nigel2392/go-django/src/core/mail"
)

func main() {
 // Create an email
 e := &email.Email{
  From:    "sender@example.com",
  To:      []string{"recipient@example.com"},
  Subject: "Hello",
  Text:    []byte("This is a test email."),
 }

 // Send the email via the default (console) backend
 err := mail.Send(e)
 if err != nil {
  panic(err)
 }
}
```

### Sending an Email via the Pooled SMTP Backend

```go
package main

import (
 "github.com/jordan-wright/email"
 "github.com/Nigel2392/go-django/src/core/mail"
)

func main() {
 // Define the SMTP configuration
 cnf := &mail.Config{
  Host:     "smtp.example.com",
  Port:     587,
  Username: "your-username",
  Password: "your-password",
  UseTLS:   true,
  MailFrom: "sender@example.com",
 }

 // Create a pooled email backend
 backend, err := mail.NewPooledEmailBackend(5, cnf)
 if err != nil {
  panic(err)
 }

 // Create an email
 e := &email.Email{
  From:    "sender@example.com",
  To:      []string{"recipient@example.com"},
  Subject: "Hello",
  Text:    []byte("This is a test email."),
 }

 // Send the email using the pooled backend
 err = backend.Send(e)
 if err != nil {
  panic(err)
 }

 // Close the backend when done
 err = backend.Close()
 if err != nil {
  panic(err)
 }
}
```

### Testing with Console Backend

To test email sending without actually sending emails, you can register and use the `consoleManager` backend to print emails to the console:

```go
mail.Register("console", mail.NewConsoleBackend(os.Stdout))
err := mail.Send(e, "console")
```
