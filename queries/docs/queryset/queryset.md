# QuerySet Reference

This document provides a reference for the `QuerySet` type in the `go-django` ORM.

It includes methods for building and executing queries, as well as managing transactions and context.

---

## QuerySet Methods

### `GoString() string`

GoString returns a string representation of the `QuerySet` for debugging purposes.

It provides additional information about the query, such as the model type and any applied filters or annotations.

### `String() string`

String returns a string representation of the `QuerySet`.

It will query the database to retrieve any results for the current query, and return a string representation of the list of results.

### `LatestQuery() QueryInfo`

LatestQuery returns information about the most recently query executed by the `QuerySet`.

It includes details such as the SQL query string and the parameters used in the query.

### `Model() attrs.Definer`

Model returns the model associated with the `QuerySet`.

It is the current model which the `QuerySet` is working on.

### `Clone() *QuerySet[T]`

Clone creates a new `QuerySet` that is a copy of the current one.

The new queryset is not able to mutate the original queryset and can be modified independently.

### `Compiler() QueryCompiler`

Returns the `QueryCompiler` used by the `QuerySet`.

This is the underlying SQL builder that generates the SQL queries for the `QuerySet`.

### `DB() DB`

Returns the database connection used by the `QuerySet`.

If the `Compiler` is in a transaction, that transaction (`*sql.Tx`) will be returned instead.

### `StartTransaction(ctx context.Context) (Transaction, error)`

Starts a new transaction for the `QuerySet`.

It returns a `Transaction` object that can be used to execute queries within the transaction context.

The transaction will be automatically added to the `Queryset`s' context, allowing it to be used for subsequent queries.

### `WithTransaction(tx Transaction) (Transaction, error)`

WithTransaction sets the `QuerySet` to use the provided transaction.

It allows the `QuerySet` to execute queries within the context of the provided transaction.

The queryset will copy the transaction to its `context.Context`, allowing it to be used for subsequent queries.

### `Context() context.Context`

Context returns the context associated with the `QuerySet`.

### `WithContext(ctx context.Context) *QuerySet[T]`

WithContext sets the context for the `QuerySet`.

If there is a transaction present in the context, it will be used for subsequent queries.

### `Prefix(prefix string) *QuerySet[T]`

Prefix sets a prefix for the SQL queries generated by the `QuerySet`.

### `Select(fields ...any) *QuerySet[T]`

Select is used to select specific fields from the model.

It takes a list of field names as arguments and returns a new QuerySet with the selected fields.

If no fields are provided, it selects all fields from the model.

If the first field is "*", it selects all fields from the model,  
extra fields (i.e. relations) can be provided thereafter - these will also be added to the selection.

How to call Select:

* `qs = qs.Select("*")`
* `qs = qs.Select("Field1", "Field2")`
* `qs = qs.Select("Field1", "Field2", "Relation.*")`
* `qs = qs.Select("*", "Relation.*")`
* `qs = qs.Select("Relation.*")`
* `qs = qs.Select("*", "Relation.Field1", "Relation.Field2", "Relation.Nested.*")`
* `qs = qs.Select("*", "Relation.Field1", "Relation.Field2", expr.FuncLower("Relation.Field3"))`

### `Distinct() *QuerySet[T]`

Distinct is used to ensure that the results of the query are unique.

It modifies the `QuerySet` to include a `DISTINCT` clause in the SQL query.

If this is not supported by the database, a panic will occur.

### `Filter(key interface{}, vals ...interface{}) *QuerySet[T]`

Filter is used to filter the results of the query based on specific conditions.

It takes a key (field name or expression) and one or more values to filter by.

It returns a new `QuerySet` with the applied filter.

The field name can be a string representing the field - [lookups](../expressions/lookups.md) are supported, e.g. `Field__contains`, `Field__gt`, etc.

### `Having(key interface{}, vals ...interface{}) *QuerySet[T]`

Having is used to filter the results of the query based on conditions applied to aggregated values.

It takes a key (field name or expression) and one or more values to filter by.

It returns a new `QuerySet` with the applied having condition.

### `Limit(n int) *QuerySet[T]`

Limit is used to limit the number of results returned by the query.

It takes an integer `n` as an argument and returns a new `QuerySet` with the limit applied.

### `Offset(n int) *QuerySet[T]`

Offset is used to skip a specified number of results in the query.

It takes an integer `n` as an argument and returns a new `QuerySet` with the offset applied.

### `OrderBy(fields ...string) *QuerySet[T]`

OrderBy is used to order the results of the query by one or more fields.

It takes a list of field names as arguments and returns a new `QuerySet` with the specified order.

The field names can be prefixed with a minus sign (`-`) to indicate descending order.

Example usage:

```go
qs = qs.OrderBy("Field1", "-Field2")
```

### `Reverse() *QuerySet[T]`

Reverse is used to reverse the order of the results in the query.

It modifies the `QuerySet` to reverse the order of the results based on the last applied `OrderBy` clause.

### `ExplicitSave() *QuerySet[T]`

ExplicitSave is used to indicate that the `QuerySet` should not automatically save changes using the model's `Save(context.Context)` method.

This will force the `QuerySet` itself to handle saving changes explicitly, allowing for more control over the save process  
and also allowing models to use the `QuerySet` inside it's `Save` method.

### `ForUpdate() *QuerySet[T]`

ForUpdate is used to lock the rows returned by the query for update.

It modifies the `QuerySet` to include a `FOR UPDATE` clause in the SQL query, ensuring that the rows are locked for the duration of the transaction.

### `GroupBy(fields ...any) *QuerySet[T]`

GroupBy is used to group the results of the query by one or more fields.

It takes a list of field names as arguments and returns a new `QuerySet` with the specified grouping.

It is typically used in conjunction with aggregation functions to calculate values for each group.

### `Annotate(aliasOrAliasMap interface{}, exprs ...expr.Expression) *QuerySet[T]`

Annotate is used to add annotations to the results of the query.

It allows you to compute additional values based on the fields of the model or related models.

It takes either an alias string, `expr.NamedExpression` or a map of alias names to [expressions](../expressions/expressions.md) as the first argument, followed by one or more expressions.

### `Scope(scopes ...func(*QuerySet[T], *QuerySetInternals) *QuerySet[T]) *QuerySet[T]`

Scope is used to apply one or more scopes to the `QuerySet`.

It allows you to encapsulate common query logic into reusable functions.

It takes one or more functions as arguments, each of which takes a `QuerySet` and `QuerySetInternals` as parameters and returns a modified `QuerySet`.

Example usage:

```go
qs = qs.Scope(
    func(qs *QuerySet[T], internals *QuerySetInternals) *QuerySet[T] {
        return qs.Filter("Field", "value")
    },
    func(qs *QuerySet[T], internals *QuerySetInternals) *QuerySet[T] {
        return qs.OrderBy("Field")
    },
)
```

## QuerySet Query Methods

The following methods are used to execute queries and retrieve results from the database.

### `All() (Rows[T], error)`

The `All` method retrieves all rows from the database for the current `QuerySet`.

It returns a `Rows[T]` object containing the results, or an error if the query fails.

The `Rows[T]` object can be iterated over to access each row (it is an alias for []*Row[T]).

Each row contains the model object and any annotations that were applied to the query.

### `Aggregate(annotations map[string]expr.Expression) (map[string]any, error)`

The `Aggregate` method performs aggregation on the results of the query.

It takes a map of annotation names to [expressions](../expressions/expressions.md) as an argument and returns a map of aggregated values.

### `BatchCreate(objects []T) ([]T, error)`

The `BatchCreate` method is used to create multiple objects in the database.

It takes a slice of objects of type `T` and returns a slice of created objects or an error if the operation fails.

The slice of objects will be chunked into batches of `qs.Limit(n int)` size, where `n` is the limit set on the `QuerySet`.

### `BatchUpdate(objects []T, exprs ...expr.NamedExpression) (int64, error)`

The `BatchUpdate` method is used to update multiple objects in the database.

It takes a slice of objects of type `T` and one or more [expressions](../expressions/expressions.md) to update the fields.

It returns the number of rows affected by the update operation or an error if the operation fails.

The slice of objects will be chunked into batches of `qs.Limit(n int)` size, where `n` is the limit set on the `QuerySet`.

### `BulkCreate(objects []T) ([]T, error)`

The `BulkCreate` method is used to create multiple objects in the database in a single operation.

It takes a slice of objects of type `T` and returns a slice of created objects or an error if the operation fails.

### `BulkUpdate(objects []T, expressions ...expr.NamedExpression) (int64, error)`

The `BulkUpdate` method is used to update multiple objects in the database in a single operation.

It takes a slice of objects of type `T` and one or more expressions to update the fields.
It returns the number of rows affected by the update operation or an error if the operation fails.

For most database drivers, this will always return 1, even if more than one row was updated.

### `Count() (int64, error)`

The `Count` method returns the number of rows that match the query.

It executes the query and returns the count of matching rows as an `int64`, or an error if the query fails.

### `Create(value T) (T, error)`

The `Create` method is used to create a single object in the database.

It takes an object of type `T` and returns the created object with it's primary key set, or an error if the operation fails.

### `Update(value T, expressions ...expr.NamedExpression) (int64, error)`

The `Update` method is used to update a single object in the database.

It takes an object of type `T` and one or more [expressions](../expressions/expressions.md) to update the fields.

It returns the number of rows affected by the update operation or an error if the operation fails.

### `Delete(objects ...T) (int64, error)`

The `Delete` method is used to delete one or more objects from the database.

It takes a variadic number of objects of type `T` and returns the number of rows affected by the delete operation or an error if the operation fails.

It requires either the objects to be passed, from which a primary key can be extracted, or the `QuerySet` to have a filter applied that matches the objects to be deleted.

### `Exists() (bool, error)`

Exists checks if any rows match the current query.

It returns `true` if at least one row matches the query, or `false` if no rows match,  
or an error if the query fails.

### `Get() (*Row[T], error)`

Get retrieves a single row from the query results.

It returns a pointer to a `Row[T]` containing the result, or an error if the query fails or no results are found.

It will return one of the following errors:

* `query_errors.ErrNoRows` if no rows are found.
* `query_errors.ErrMultipleRows` if more than one row is found.

Or it will return the error from the database driver if the query fails.

### `GetOrCreate(value T) (T, bool, error)`

GetOrCreate retrieves a single row from the query results, or creates a new row if no matching row is found.

It takes an object of type `T` and returns the found or created object, a boolean indicating whether the object was created,
and an error if the query fails or the creation fails.

### `First() (*Row[T], error)`

First retrieves the first row from the query results.

It returns a pointer to a `Row[T]` containing the first result, or an error if the query fails or no results are found.

### `Last() (*Row[T], error)`

Last retrieves the last row from the query results.

This method will call `Reverse()` on the `QuerySet` to ensure that the last row is retrieved correctly.

It returns a pointer to a `Row[T]` containing the last result, or an error if the query fails or no results are found.

### `Exec(sqlStr string, args ...interface{}) (sql.Result, error)`

The `Exec` method executes a raw SQL command against the database.

It takes a SQL string and optional arguments, and returns the result of the execution as an `sql.Result`, or an error if the execution fails.

### `Raw(sqlStr string, args ...interface{}) (*sql.Rows, error)`

The `Raw` method executes a raw SQL query against the database.

It takes a SQL string and optional arguments, and returns a pointer to `sql.Rows` containing the results of the query, or an error if the query fails.

### `Row(sqlStr string, args ...interface{}) *sql.Row`

The `Row` method executes a raw SQL query and returns a single row.

It takes a SQL string and optional arguments, and returns a pointer to `sql.Row` containing the result of the query.

### `Values(fields ...any) ([]map[string]any, error)`

Values retrieves the values of the specified fields from the query results.

It takes a list of field names as arguments and returns a slice of maps, where each map contains the field values for each row.

If no fields are provided, it retrieves all fields from the model (and annotations if they are present).

### `ValuesList(fields ...any) ([][]interface{}, error)`

ValuesList retrieves the values of the specified fields from the query results as a slice of slices.

It takes a list of field names as arguments and returns a slice of slices, where each inner slice contains the field values for each row.

If no fields are provided, or `*` is provided, it retrieves all fields from the model (and annotations if they are present).
